<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>商品类型</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link href="../../AppData/layui/css/layui.css" rel="stylesheet" />
    <style>

        .layui-tree-entry:hover {
            background: rgba(128,128,128,.2);
        }

        .layui-tree-set {
            margin-left: 20px;
        }

        #layui_tree {
            width: 20%;
            float: left;
        }

        #layui_table {
            width: 78%;
            position: relative;
            float: left;
        }
    </style>
</head>
<body>
    <main>
        <!--左侧商品类型树形结构-->
        <div id="layui_tree">
            <blockquote class="layui-elem-quote">
                商品类型
            </blockquote>
            <div class="layui-btn-container">

                <button data-method="offset" data-type="auto" id="layerDemo" type="button" class="layui-btn layui-btn-sm" lay-demo="getChecked">添加</button>
                <!--<button type="button" class="layui-btn layui-btn-sm" lay-demo="getChecked">获取选中节点数据</button>-->
            </div>
            <div id="test9" class="demo-tree-more"></div>
        </div>
        <!--右侧对应商品类型的商品管理区-->
        <div id="layui_table">
            <blockquote class="layui-elem-quote">
                商品列表
            </blockquote>

            <table class="layui-hide" id="test" lay-filter="test"></table>
        </div>
        <!--添加商品类型模态框-->
        <form class="layui-form" id="from" action="" hidden>
            <div class="layui-form-item">
                <label class="layui-form-label">类型层级：</label>
                <div class="layui-input-block " id="IsPurchased">
                    <input type="text" id="type" name="type" value="顶级" disabled lay-verify="title" autocomplete="off" placeholder="请输入类型名称" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">父级名称：</label>
                <div class="layui-input-block">
                    <input type="text" id="parentId" name="parentId" guid="" value="顶级" disabled lay-verify="title" autocomplete="off" placeholder="请输入类型名称" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">类型名称：</label>
                <div class="layui-input-block">
                    <input type="text" name="cateName" lay-verify="title" autocomplete="off" placeholder="请输入类型名称" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit="" lay-filter="demo1">提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </main>
    <script src="../../AppData/layui/jquery-3.3.1.min.js"></script>
    <script src="../../AppData/layui/layui.js"></script>
    <script src="../../Scripts/Shopping/master.js"></script>

    <script>
        function loadtree() {
            $.ajax({
                type: "post",
                url: "typehandler.ashx?action=tree",
                dataType: 'json',
                success: function (res) {
                    console.log(res, "数据源");
                    var data = [{}];
                    layui.use(['tree', 'util'], function () {
                        var tree = layui.tree,
                            layer = layui.layer,
                            util = layui.util,
                            data1 = res
                        tree.render({
                            elem: '#test9',
                            id: 'treedept',
                            data: data1,
                            showCheckbox: true,//显示多选框
                            showLine: true,//显示线
                            accordion: true,//手风琴模式
                            drag: false,//拖拽
                            skin: "laySimple", // laySimple主题风格
                            showSearch: true,//显示搜索框
                            edit: true,
                            // edit: ['add', 'update', 'del', 'banuser'], //操作节点的图标,
                            click: function (obj) {
                                //  $(".radio").eq(0).removeAttr("checked");
                                $("#parentId").val(obj.data.title);
                                $("#parentId").attr("guid", obj.data.id);
                                $("#type").val("子级");
                                console.log(obj.data.title, "点击查看商品");
                            },
                            operate: function (obj) {
                                var type = obj.type; //得到操作类型：add、edit、del
                                var data = obj.data; //得到当前节点的数据
                                var elem = obj.elem; //得到当前节点元素
                                console.log(type, "当前选择中的是..");
                                if (type === 'del') {
                                    var arr = obj.data;
                                    if (arr.id > 0 && (!typeof arr.id != 'undefined')) {
                                        if (arr.children.length > 0) {
                                            layer.confirm('该商品类型下有子类型是否确认删除?', function (index) {
                                                deleteDept(arr.id);
                                                if (msg1.trim() == "删除成功！") {
                                                    elem.remove();
                                                }
                                                htmlInfo(msg1);
                                                layer.close(index);
                                                loadtree();
                                            });
                                        } else {
                                            layer.confirm('是否确认删除?', function (index) {
                                                deleteDept(arr.id);
                                                if (msg1.trim() == "删除成功！") {
                                                    elem.remove();
                                                }
                                                htmlInfo(msg1);
                                                layer.close(index);
                                                loadtree()
                                            });
                                        }
                                    } else {
                                        elem.remove();
                                    }
                                }
                                if (type === 'update ') {

                                    layer.msg("开发中..");
                                }

                            },
                            //util.event('lay-demo', {//多选框获取数据
                            //    getChecked: function (othis) {
                            //        var idList = [];
                            //        var arr = document.getElementsByClassName("layui-form-checked");
                            //        for (var i = 0; i < arr.length; i++) {
                            //            let a = arr[i];
                            //            if ($(a).parent().parent().parent().attr("data-id") != "undefined") {
                            //                idList.push($(a).parent().parent().parent().attr("data-id"));
                            //            }

                            //        }
                            //        if (idList.length == 0) {

                            //            layer.msg("请至少选择一个部门进行删除");
                            //        } else {
                            //            layer.confirm('是否确认删除?', function (index) {
                            //                deleteDeptList(idList);  //删除函数
                            //                htmlInfo(msg);
                            //                layer.close(index);
                            //                loadtree()
                            //            });
                            //        }
                            //    }
                            //});

                        });
                    });
                }
            });
        }
        loadtree();
        //菜单搜索！！
        //$("input[placeholder='请输入关键字进行过滤']").change(function () {
        //    console.log(1);
        //});
    </script>

    <script>


        layui.use(['form', 'tree', 'util', 'layer'], function () {
            var tree = layui.tree
                , layer = layui.layer
                , util = layui.util
                , form = layui.form

            /**添加商品类型 */
            var active = {
                offset: function (othis) {

                    var type = othis.data('type')
                        , text = othis.text();
                    layer.open({
                        type: 1
                        , title: "添加商品类型"
                        , area: '50%'
                        , offset: type
                        , id: 'layerDemo' + type //防止重复弹出
                        , content: $('#from')
                        // , btn: '关闭全部'
                        , btnAlign: 'l' //按钮居中
                        , shade: .1 //不显示遮罩
                        , yes: function () {
                            layer.closeAll();
                        }
                    });
                }
            };
            $('#layerDemo').on('click', function () {
                var othis = $(this), method = othis.data('method');
                active[method] ? active[method].call(this, othis) : '';
            });

            ///**单选框的事件绑定 */
            //var i = 0;
            //form.on('radio(testRadio)', function (data) {
            //    i += 1;
            //    if (data.value == '1') {
            //        $("#Parent").hide();
            //    } else {
            //        $("#Parent").show();
            //        if (i > 1) return
            //        //加载父级菜单
            //        ajax_request({
            //            url: "typehandler.ashx?action=list",
            //            callback: function (data) {
            //                console.log(data, "0000");
            //                json = JSON.parse(data);
            //                if (json.code == 0) {
            //                    console.log(data, "model");
            //                    $.each(json.data, function (index, item) {
            //                           $('#interest').append(new Option(item.CateName, item.CateId));// 下拉菜单里添加元素
            //                        $("#Parent >div > div> dl").append('<dd lay-value="' + item.CateId + '" class="">' + item.CateName + '</dd>');
            //                    });
            //                } else {
            //                    console.log(data);
            //                    layer.msg("服务器出错了，请重试");
            //                }
            //            }
            //        });
            //    }
            //});
            //表单的提交
            form.on('submit(demo1)', function (data) {
                console.log(data.field, "请求参数");
                data.field.type = data.field.type == "顶级" ? "1" : "2";
                data.field.parentId = $("#parentId").attr("guid");
                //layer.alert(JSON.stringify(data.field), {
                //    title: '最终的提交信息'
                //});
                //加载父级菜单
                ajax_request({
                    url: "typehandler.ashx?action=add",
                    data: data.field,
                    callback: function (data) {
                        data = JSON.parse(data);
                        if (data.code == 0) {
                           layer.msg("添加成功");
                           layer.closeAll("page"); //关闭（信息框，默认dialog）1（page页面层）2（iframe层）3（loading加载层）4（tips层）
                           loadtree();                                               
                        } else {
                            console.log(data);
                            layer.msg("服务器出错了，请重试");
                        }
                    }

                });
                return false;
            });
        });
    </script>
</body>
</html>


